---
import { Image } from "astro:assets";
import { categoryData } from "../../data/Items.js";
---

<style>
  /* Use Tailwind's `apply` or keep styles separate for clarity. This is fine. */
  .category-card.is-active {
    border-color: #bf9b42;
    transform: scale(1.05);
    background-color: #fefcf8; /* A subtle background for the active state */
  }

  .scroll-button {
    transition:
      opacity 0.3s ease,
      transform 0.3s ease;
    transform: translateY(-50%);
  }

  .scroll-button.is-hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-50%) scale(0.8);
  }
</style>

<div id="category-scroller" class="relative group">
  <!-- Left Scroll Button -->
  <button
    type="button"
    id="scroll-left-button"
    aria-label="Scroll left"
    class="scroll-button absolute top-1/2 left-2 md:left-4 z-10 bg-white/80 backdrop-blur-sm rounded-full p-2 shadow-md hover:bg-white focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2 border-2 border-[#bf9b42]"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 sm:h-6 sm:w-6 text-gray-800"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"
      ></path>
    </svg>
  </button>

  <!-- Horizontally scrolling container -->
  <div
    id="scrolling-container"
    class="flex gap-4 sm:gap-6 overflow-x-auto no-scrollbar pb-5 px-4 lg:px-16 pt-6 scroll-smooth"
  >
    {
      categoryData.map((category, index) => (
        <button
          type="button"
          data-category-id={category.id}
          class:list={[
            "category-card border-2 border-transparent rounded-2xl transition-all duration-300 cursor-pointer p-3 flex flex-col items-center flex-shrink-0 hover:border-[#bf9b42] hover:transform hover:-translate-y-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2",
            { "is-active": index === 0 },
          ]}
        >
          <div class="flex justify-center items-center w-14 h-14 pointer-events-none">
            <Image
              src={category.imageUrl}
              alt={category.title}
              class="max-h-full max-w-full object-contain"
            />
          </div>
          <p class="font-semibold text-center pointer-events-none mt-2 text-sm text-gray-800">
            {category.title}
          </p>
        </button>
      ))
    }
  </div>

  <!-- Right Scroll Button -->
  <button
    type="button"
    id="scroll-right-button"
    aria-label="Scroll right"
    class="scroll-button absolute top-1/2 right-2 md:right-4 z-10 bg-white/80 backdrop-blur-sm rounded-full p-2 shadow-md hover:bg-white focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2 border-2 border-[#bf9b42]"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 sm:h-6 sm:w-6 text-gray-800"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"
      ></path>
    </svg>
  </button>
</div>

<script>
  // Encapsulate the logic to avoid polluting the global scope
  function setupCategoryScroller(scrollerId: string) {
    const scroller = document.getElementById(scrollerId);
    if (!scroller) return;

    const container = scroller.querySelector("#scrolling-container");
    const leftButton = scroller.querySelector("#scroll-left-button");
    const rightButton = scroller.querySelector("#scroll-right-button");
    const categoryCards = scroller.querySelectorAll(".category-card");

    if (!container || !leftButton || !rightButton) return;

    const scrollAmount = 300; // The distance to scroll on each click

    const updateButtonState = () => {
      const isScrollable = container.scrollWidth > container.clientWidth;
      if (!isScrollable) {
        leftButton.classList.add("is-hidden");
        rightButton.classList.add("is-hidden");
        return;
      }

      const maxScrollLeft = container.scrollWidth - container.clientWidth;
      leftButton.classList.toggle("is-hidden", container.scrollLeft <= 0);
      rightButton.classList.toggle(
        "is-hidden",
        container.scrollLeft >= maxScrollLeft - 1,
      );
    };

    // --- Event Listeners ---
    leftButton.addEventListener("click", () => {
      container.scrollBy({ left: -scrollAmount, behavior: "smooth" });
    });

    rightButton.addEventListener("click", () => {
      container.scrollBy({ left: scrollAmount, behavior: "smooth" });
    });

    container.addEventListener("scroll", updateButtonState, { passive: true });
    window.addEventListener("resize", updateButtonState);

    // Add click listeners to each category card
    categoryCards.forEach((card) => {
      card.addEventListener("click", () => {
        // Remove active class from all other cards
        categoryCards.forEach((c) => c.classList.remove("is-active"));
        // Add active class to the clicked card
        card.classList.add("is-active");

        // **UX Improvement**: Scroll the active item into the center
        card.scrollIntoView({
          behavior: "smooth",
          inline: "center",
          block: "nearest",
        });
      });
    });

    // Initial check
    // Use requestAnimationFrame for a more robust check after layout paint
    requestAnimationFrame(() => {
      requestAnimationFrame(updateButtonState);
    });
  }

  // Initialize the scroller on page load
  document.addEventListener("DOMContentLoaded", () => {
    setupCategoryScroller("category-scroller");
  });
</script>
