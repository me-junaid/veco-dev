---
import { Image } from "astro:assets";
import { categoryData } from "../../data/Items.js";
---

<style>
  .category-card {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .category-card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 1rem;
    padding: 2px;
    background: linear-gradient(135deg, #ec4899, #f97316, #bf9b42);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .category-card.is-active::before {
    opacity: 1;
  }

  .category-card.is-active {
    transform: translateY(-8px) scale(1.05);
    background: linear-gradient(135deg, #fef3c7 0%, #fce7f3 50%, #fed7aa 100%);
    box-shadow: 0 20px 25px -5px rgba(191, 155, 66, 0.2), 0 10px 10px -5px rgba(191, 155, 66, 0.1);
  }

  .category-card:hover:not(.is-active) {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .category-icon {
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .category-card:hover .category-icon {
    transform: scale(1.1) rotate(5deg);
  }

  .category-card.is-active .category-icon {
    transform: scale(1.15);
    filter: drop-shadow(0 4px 6px rgba(191, 155, 66, 0.3));
  }

  .scroll-button {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(-50%);
  }

  .scroll-button:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 10px 15px -3px rgba(191, 155, 66, 0.3);
  }

  .scroll-button.is-hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateY(-50%) scale(0.7);
  }

  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .category-label {
    transition: all 0.3s ease;
  }

  .category-card.is-active .category-label {
    background: linear-gradient(135deg, #ec4899, #f97316, #bf9b42);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
  }

  .scroll-gradient-left,
  .scroll-gradient-right {
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(191, 155, 66, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(191, 155, 66, 0);
    }
  }

  .category-card.is-active {
    animation: pulse-glow 2s infinite;
  }

  .badge-new {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #ec4899, #f97316);
    color: white;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 9999px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    animation: badge-bounce 2s infinite;
  }

  @keyframes badge-bounce {
    0%, 100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-4px) scale(1.05);
    }
  }
</style>

<div id="category-scroller" class="relative group">
  <!-- Gradient Overlays for better UX -->
  <div class="scroll-gradient-left absolute left-0 top-0 bottom-0 w-20 md:w-32 bg-gradient-to-r from-white via-white/50 to-transparent z-[5] pointer-events-none opacity-0"></div>
  <div class="scroll-gradient-right absolute right-0 top-0 bottom-0 w-20 md:w-32 bg-gradient-to-l from-white via-white/50 to-transparent z-[5] pointer-events-none opacity-0"></div>

  <!-- Left Scroll Button -->
  <button
    type="button"
    id="scroll-left-button"
    aria-label="Scroll categories left"
    class="scroll-button absolute top-1/2 left-1 md:left-3 z-10 bg-gradient-to-br from-white to-gray-50 backdrop-blur-md rounded-full p-2.5 md:p-3 shadow-xl hover:shadow-2xl focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2 border border-gray-200 hover:border-[#bf9b42] group/btn"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 md:h-6 md:w-6 text-gray-700 group-hover/btn:text-[#bf9b42] transition-colors"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2.5"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>

  <!-- Horizontally scrolling container -->
  <div
    id="scrolling-container"
    class="flex gap-3 md:gap-4 overflow-x-auto no-scrollbar p-8  scroll-smooth"
  >
    {categoryData.map((category, index) => (
      <button
        type="button"
        data-category-id={category.id}
        class:list={[
          "category-card relative bg-white border-2 border-gray-100 rounded-2xl transition-all duration-300 cursor-pointer p-4 md:p-5 flex flex-col items-center flex-shrink-0 hover:border-gray-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2 min-w-[100px] md:min-w-[120px]",
          { "is-active": index === 0 },
        ]}
      >
        {/* Optional: Add "NEW" badge for featured categories */}
        {/* {index < 2 && (
          <span class="badge-new">NEW</span>
        )} */}
        
        <div class="category-icon flex justify-center items-center w-16 h-16 md:min-w-30 md:min-h-30 pointer-events-none mb-3">
          <Image
            src={category.imageUrl}
            alt={category.title}
            class="max-h-full max-w-full object-contain"
          />
        </div>
        
        <p class="category-label font-semibold text-center pointer-events-none text-xs md:text-sm text-gray-800 leading-tight">
          {category.title}
        </p>
        
        {/* Active indicator dot */}
        <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-gradient-to-r from-pink-500 to-orange-500 opacity-0 transition-opacity duration-300" 
             style={index === 0 ? "opacity: 1;" : ""}>
        </div>
      </button>
    ))}
  </div>

  <!-- Right Scroll Button -->
  <button
    type="button"
    id="scroll-right-button"
    aria-label="Scroll categories right"
    class="scroll-button absolute top-1/2 right-1 md:right-3 z-10 bg-gradient-to-br from-white to-gray-50 backdrop-blur-md rounded-full p-2.5 md:p-3 shadow-xl hover:shadow-2xl focus-visible:ring-2 focus-visible:ring-[#bf9b42] focus-visible:ring-offset-2 border border-gray-200 hover:border-[#bf9b42] group/btn"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-5 w-5 md:h-6 md:w-6 text-gray-700 group-hover/btn:text-[#bf9b42] transition-colors"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2.5"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path>
    </svg>
  </button>
</div>

<script>
  function setupCategoryScroller(scrollerId: string): void {
    const scroller = document.getElementById(scrollerId);
    if (!scroller) return;

    const container = scroller.querySelector<HTMLElement>("#scrolling-container");
    const leftButton = scroller.querySelector<HTMLButtonElement>("#scroll-left-button");
    const rightButton = scroller.querySelector<HTMLButtonElement>("#scroll-right-button");
    const categoryCards = scroller.querySelectorAll<HTMLButtonElement>(".category-card");
    const leftGradient = scroller.querySelector<HTMLElement>(".scroll-gradient-left");
    const rightGradient = scroller.querySelector<HTMLElement>(".scroll-gradient-right");
    const activeIndicators = scroller.querySelectorAll<HTMLElement>(".category-card > div:last-child");

    if (!container || !leftButton || !rightButton) return;

    const scrollAmount = 280;

    const updateButtonState = (): void => {
      const isScrollable = container.scrollWidth > container.clientWidth;
      
      if (!isScrollable) {
        leftButton.classList.add("is-hidden");
        rightButton.classList.add("is-hidden");
        leftGradient?.classList.remove("opacity-0");
        leftGradient?.classList.add("opacity-0");
        rightGradient?.classList.remove("opacity-0");
        rightGradient?.classList.add("opacity-0");
        return;
      }

      const maxScrollLeft = container.scrollWidth - container.clientWidth;
      const isAtStart = container.scrollLeft <= 1;
      const isAtEnd = container.scrollLeft >= maxScrollLeft - 1;

      leftButton.classList.toggle("is-hidden", isAtStart);
      rightButton.classList.toggle("is-hidden", isAtEnd);

      // Show/hide gradient overlays
      if (leftGradient && rightGradient) {
        leftGradient.style.opacity = isAtStart ? "0" : "1";
        rightGradient.style.opacity = isAtEnd ? "0" : "1";
      }
    };

    // Smooth scroll with easing
    const smoothScrollTo = (target: number): void => {
      container.scrollTo({
        left: target,
        behavior: "smooth"
      });
    };

    leftButton.addEventListener("click", () => {
      smoothScrollTo(container.scrollLeft - scrollAmount);
    });

    rightButton.addEventListener("click", () => {
      smoothScrollTo(container.scrollLeft + scrollAmount);
    });

    container.addEventListener("scroll", updateButtonState, { passive: true });
    window.addEventListener("resize", updateButtonState);

    // Category card interactions
    categoryCards.forEach((card, index) => {
      card.addEventListener("click", () => {
        // Remove active state from all cards
        categoryCards.forEach((c) => c.classList.remove("is-active"));
        
        // Add active state to clicked card
        card.classList.add("is-active");

        // Update active indicator dots
        activeIndicators.forEach((indicator, i) => {
          indicator.style.opacity = i === index ? "1" : "0";
        });

        // Scroll active card to center with improved positioning
        const cardRect = card.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const scrollOffset = cardRect.left - containerRect.left - (containerRect.width / 2) + (cardRect.width / 2);
        
        smoothScrollTo(container.scrollLeft + scrollOffset);
      });

      // Add keyboard navigation
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          card.click();
        }
      });
    });

    // Touch/drag scrolling enhancement
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;

    container.addEventListener("mousedown", (e) => {
      isDragging = true;
      startX = e.pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
      container.style.cursor = "grabbing";
    });

    container.addEventListener("mouseleave", () => {
      isDragging = false;
      container.style.cursor = "grab";
    });

    container.addEventListener("mouseup", () => {
      isDragging = false;
      container.style.cursor = "grab";
    });

    container.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const x = e.pageX - container.offsetLeft;
      const walk = (x - startX) * 2;
      container.scrollLeft = scrollLeft - walk;
    });

    // Set cursor style
    container.style.cursor = "grab";

    // Initial state check with RAF for better timing
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        updateButtonState();
      });
    });

    // Intersection Observer for fade-in animation
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry, index) => {
          if (entry.isIntersecting) {
            setTimeout(() => {
              entry.target.classList.add("animate-fade-in");
            }, index * 50);
          }
        });
      },
      { threshold: 0.1 }
    );

    categoryCards.forEach((card) => observer.observe(card));
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupCategoryScroller("category-scroller");
  });
</script>